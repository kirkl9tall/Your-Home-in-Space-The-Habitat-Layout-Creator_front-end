# Blender API Integration Guide

## Overview
This integration allows your space habitat designer to use custom 3D models generated by Blender instead of basic geometric shapes. Your Blender API can create detailed, realistic space station modules with proper equipment, docking ports, and ISS-like details.

## Setup Instructions

### 1. Environment Configuration
Copy `.env.local.example` to `.env.local` and configure your Blender API:

```bash
cp .env.local.example .env.local
```

Edit `.env.local` with your settings:
```
VITE_BLENDER_API_URL=http://your-blender-api-url:8000/api/v1
VITE_BLENDER_API_KEY=your-api-key
```

### 2. Blender API Requirements

Your Blender API should implement these endpoints:

#### POST `/api/v1/models/modules`
Generate a new 3D module model.

**Request Body:**
```json
{
  "moduleType": "CREW_SLEEP",
  "dimensions": {
    "width": 2.0,
    "height": 2.1,
    "depth": 2.2
  },
  "details": {
    "dockingPorts": 1,
    "windows": 2,
    "equipment": ["bed", "storage", "air_vent"],
    "materialType": "composite"
  },
  "format": "gltf"
}
```

**Response:**
```json
{
  "id": "uuid-here",
  "moduleType": "CREW_SLEEP",
  "downloadUrl": "http://your-api/models/download/uuid-here.gltf",
  "format": "gltf",
  "fileSize": 1024000,
  "generatedAt": "2025-09-29T12:00:00Z",
  "metadata": {
    "vertices": 5420,
    "faces": 8340,
    "materials": 3
  }
}
```

#### GET `/api/v1/models/download/{id}.{format}`
Download the generated 3D model file.

**Response:** Binary model file (GLB, GLTF, OBJ, etc.)

### 3. Supported Module Types

The system will request models for these NASA functional areas:

| Module Type | Description | Recommended Features |
|-------------|-------------|---------------------|
| `CREW_SLEEP` | Sleep quarters | Sleeping restraints, personal storage, lighting |
| `HYGIENE` | Shower/bathroom | Water collection system, air circulation |
| `EXERCISE` | Fitness area | Exercise equipment mounts, safety restraints |
| `FOOD_PREP` | Kitchen | Food storage, heating elements, utensils |
| `MEDICAL` | Medical bay | Examination equipment, storage cabinets |
| `AIRLOCK` | Entry/exit chamber | Pressure seals, suit storage, controls |
| `ECLSS` | Life support | Air/water recycling equipment, filters |
| `WORKSTATION` | Computer desk | Displays, keyboards, cable management |
| `GLOVEBOX` | Science lab | Sealed chambers, manipulation tools |
| `STOWAGE` | Storage area | Compartmentalized storage, access panels |

### 4. Model Requirements

#### File Formats
- **Recommended:** GLTF 2.0 (`.gltf` or `.glb`)
- **Supported:** OBJ (`.obj` + `.mtl`)
- **Future:** FBX (`.fbx`)

#### Model Specifications
- **Scale:** 1 unit = 1 meter
- **Orientation:** Y-up, Z-forward
- **Polygons:** < 10,000 faces per module (for performance)
- **Materials:** PBR materials preferred
- **Textures:** Maximum 2048x2048 resolution

#### Recommended Details
- **Docking ports:** Standardized connection points
- **Equipment:** Realistic space station components
- **Materials:** Metallic surfaces, composite panels
- **Lighting:** Proper normal maps for realistic lighting

### 5. Integration Architecture

```
Frontend (React + Three.js)
    â†“ HTTP Request
Blender API Server
    â†“ Python Blender Automation
Blender Application
    â†“ Export
3D Model Files (GLTF/GLB)
    â†“ Download
Three.js Scene Rendering
```

### 6. Example Blender Python Script

Here's a basic Python script structure for your Blender API:

```python
import bpy
import bmesh
from mathutils import Vector

def generate_crew_sleep_module(width, height, depth):
    # Clear existing mesh
    bpy.ops.object.select_all(action='SELECT')
    bpy.ops.object.delete()
    
    # Create base capsule shape
    bpy.ops.mesh.primitive_cube_add(
        size=2,
        location=(0, 0, 0)
    )
    
    # Add rounded corners
    bpy.context.object.modifiers.new(name="Bevel", type='BEVEL')
    bpy.context.object.modifiers["Bevel"].width = 0.1
    
    # Scale to dimensions
    bpy.context.object.scale = (width/2, height/2, depth/2)
    
    # Add interior details (bed, storage, etc.)
    add_crew_sleep_interior()
    
    # Export as GLTF
    bpy.ops.export_scene.gltf(
        filepath="/tmp/crew_sleep_module.gltf",
        export_format='GLTF_SEPARATE'
    )

def add_crew_sleep_interior():
    # Add sleeping restraint system
    bpy.ops.mesh.primitive_cube_add(
        size=(1.8, 0.1, 0.8),
        location=(0, 0, -0.5)
    )
    
    # Add storage compartments
    for i in range(3):
        bpy.ops.mesh.primitive_cube_add(
            size=(0.3, 0.3, 0.2),
            location=(0.7, 0, -0.3 + i*0.3)
        )
    
    # Add air ventilation grilles
    bpy.ops.mesh.primitive_cylinder_add(
        radius=0.1,
        depth=0.05,
        location=(0, 0.8, 0.8)
    )
```

### 7. Testing the Integration

1. **Enable Blender Models** in the Quick Actions panel
2. **Add a module** - the system will try Blender API first
3. **Check browser console** for API requests and responses
4. **Fallback behavior** - if Blender API fails, uses geometric shapes

### 8. Performance Optimization

- **Model Caching:** Models are cached locally to avoid re-downloading
- **Progressive Loading:** Show basic geometry while Blender model loads
- **Error Handling:** Graceful fallback to geometric shapes
- **Background Processing:** API requests don't block UI

### 9. Troubleshooting

#### Common Issues:

**API Connection Errors**
- Check `VITE_BLENDER_API_URL` in `.env.local`
- Verify your Blender API server is running
- Check network connectivity and CORS settings

**Model Loading Errors**
- Ensure GLTF files are valid (test in Blender or other viewers)
- Check file size limits (large models may timeout)
- Verify model scale and orientation

**Performance Issues**
- Reduce polygon count in Blender models
- Optimize textures (smaller file sizes)
- Enable model caching

#### Debug Mode:
Open browser console to see detailed logs:
```javascript
// Enable debug logging
localStorage.setItem('debugBlenderAPI', 'true');
```

### 10. Future Enhancements

- **Model Variants:** Different configurations per module type
- **Real-time Preview:** Live preview while Blender generates model
- **Custom Parameters:** User-adjustable model details
- **Model Library:** Pre-built model collections
- **Collaborative Editing:** Multi-user model sharing

## API Implementation Example

If you need help implementing the Blender API server, here's a FastAPI example:

```python
from fastapi import FastAPI, BackgroundTasks
from fastapi.responses import FileResponse
import subprocess
import uuid
from pydantic import BaseModel

app = FastAPI()

class ModuleRequest(BaseModel):
    moduleType: str
    dimensions: dict
    details: dict = {}
    format: str = "gltf"

@app.post("/api/v1/models/modules")
async def generate_module(request: ModuleRequest, background_tasks: BackgroundTasks):
    model_id = str(uuid.uuid4())
    
    # Generate model in background
    background_tasks.add_task(
        generate_blender_model,
        model_id,
        request.moduleType,
        request.dimensions
    )
    
    return {
        "id": model_id,
        "moduleType": request.moduleType,
        "downloadUrl": f"http://localhost:8000/api/v1/models/download/{model_id}.gltf",
        "format": request.format,
        "generatedAt": datetime.now().isoformat()
    }

@app.get("/api/v1/models/download/{filename}")
async def download_model(filename: str):
    return FileResponse(f"/tmp/models/{filename}")

def generate_blender_model(model_id: str, module_type: str, dimensions: dict):
    # Call Blender with Python script
    subprocess.run([
        "blender",
        "--background",
        "--python", f"scripts/generate_{module_type.lower()}.py",
        "--",
        model_id,
        str(dimensions["width"]),
        str(dimensions["height"]),
        str(dimensions["depth"])
    ])
```

This integration will transform your space habitat designer from basic geometric shapes to photorealistic space station modules! ðŸš€